<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multrix Server</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
<style>
  #apikey-modal {
    display: flex;
    position: fixed; top: 0; left:0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); justify-content: center; align-items: center;
    z-index: 1000;
  }
  #apikey-content {
    background: white; padding: 20px; text-align: center; border-radius: 8px;
  }
  textarea { width: 100%; }
</style>
</head>
<body>

<div id="apikey-modal">
  <div id="apikey-content">
    <p>To access the site, copy your API key below (27 seconds to copy):</p>
    <input type="text" id="api-key-input" value="aksth$5:&@dfhafkotn" readonly>
    <p id="timer">27</p>
    <button onclick="copyApiKey()">Copy API Key</button>
  </div>
</div>

<h1 id="server-name">Server</h1>

<h2>Upload File</h2>
<input type="file" id="file-input">
<button onclick="uploadFile()">Upload</button>

<h2>Files</h2>
<ul id="file-list"></ul>

<h2>Python Editor 1</h2>
<textarea id="editor1" rows="10" cols="80">print("Hello from Editor 1")</textarea><br>
<button onclick="runCode('editor1', 'output1')">Run Code</button>
<pre id="output1"></pre>

<h2>Python Editor 2</h2>
<textarea id="editor2" rows="10" cols="80">print("Hello from Editor 2")</textarea><br>
<button onclick="runCode('editor2', 'output2')">Run Code</button>
<pre id="output2"></pre>

<script>
let pyodideReady = false;
let pyodide;

async function loadPyodideLib() {
    pyodide = await loadPyodide();
    pyodideReady = true;
}
loadPyodideLib();

// API key modal
let timer = 27;
const timerElem = document.getElementById("timer");
const modal = document.getElementById("apikey-modal");

const interval = setInterval(() => {
    timer--;
    timerElem.textContent = timer;
    if (timer <= 0) {
        clearInterval(interval);
        modal.style.display = "none";
    }
}, 1000);

function copyApiKey() {
    const input = document.getElementById("api-key-input");
    input.select();
    document.execCommand("copy");
    alert("API key copied! You have 27 seconds to paste it.");
}

// Get server ID from URL
const params = new URLSearchParams(window.location.search);
const serverId = params.get("id");
const serverName = params.get("name");
document.getElementById("server-name").textContent = serverName;

// Fetch server files
async function fetchServerFiles() {
    const res = await fetch(`http://127.0.0.1:8000/servers/${serverId}`);
    const data = await res.json();
    const list = document.getElementById("file-list");
    list.innerHTML = "";
    if(data.files) {
        data.files.forEach(f => {
            const li = document.createElement("li");
            li.textContent = f;
            list.appendChild(li);
        });
    }
}
fetchServerFiles();

// Upload file
async function uploadFile() {
    const input = document.getElementById("file-input");
    if(input.files.length === 0) return alert("Select a file first!");
    const file = input.files[0];

    const formData = new FormData();
    formData.append("server_id", serverId);
    formData.append("file", file);

    const res = await fetch("http://127.0.0.1:8000/upload/", {
        method: "POST",
        body: formData
    });
    const data = await res.json();
    alert(`Uploaded: ${data.filename}`);
    fetchServerFiles();
}

// Run Python code for any editor
async function runCode(editorId, outputId) {
    if(!pyodideReady) return alert("Pyodide not loaded yet");
    const code = document.getElementById(editorId).value;
    try {
        let output = await pyodide.runPythonAsync(code);
        document.getElementById(outputId).textContent = output ?? "";
    } catch(e) {
        document.getElementById(outputId).textContent = e;
    }
}
</script>
</body>
</html>