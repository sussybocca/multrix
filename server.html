<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multrix Server</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
</head>
<body>
<h1 id="server-name">Server</h1>

<h2>Upload File</h2>
<input type="file" id="file-input">
<button onclick="uploadFile()">Upload</button>

<h2>Files</h2>
<ul id="file-list"></ul>

<h2>Python Editor</h2>
<textarea id="editor" rows="10" cols="80">print("Hello from Multrix!")</textarea><br>
<button onclick="runCode()">Run Code</button>
<pre id="output"></pre>

<script>
let pyodideReady = false;
let pyodide;

async function loadPyodideLib() {
    pyodide = await loadPyodide();
    pyodideReady = true;
}
loadPyodideLib();

// Get server ID from URL
const params = new URLSearchParams(window.location.search);
const serverId = params.get("id");
const serverName = params.get("name");
document.getElementById("server-name").textContent = serverName;

// Fetch server files
async function fetchServerFiles() {
    const res = await fetch(`http://127.0.0.1:8000/servers/${serverId}`);
    const data = await res.json();
    const list = document.getElementById("file-list");
    list.innerHTML = "";
    if(data.files) {
        data.files.forEach(f => {
            const li = document.createElement("li");
            li.textContent = f;
            list.appendChild(li);
        });
    }
}
fetchServerFiles();

// Upload file
async function uploadFile() {
    const input = document.getElementById("file-input");
    if(input.files.length === 0) return alert("Select a file first!");
    const file = input.files[0];

    const formData = new FormData();
    formData.append("server_id", serverId);
    formData.append("file", file);

    const res = await fetch("http://127.0.0.1:8000/upload/", {
        method: "POST",
        body: formData
    });
    const data = await res.json();
    alert(`Uploaded: ${data.filename}`);
    fetchServerFiles();
}

// Run Python code
async function runCode() {
    if(!pyodideReady) return alert("Pyodide not loaded yet");
    const code = document.getElementById("editor").value;
    try {
        let output = await pyodide.runPythonAsync(code);
        document.getElementById("output").textContent = output ?? "";
    } catch(e) {
        document.getElementById("output").textContent = e;
    }
}
</script>
</body>
</html>
